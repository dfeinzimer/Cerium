<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Titan Rover Cerium</title>
    <meta charset="utf-8"/>
    <script src="https://static.robotwebtools.org/EventEmitter2/current/eventemitter2.min.js"></script>
    <script type="text/javascript" src="http://static.robotwebtools.org/roslibjs/current/roslib.min.js"></script>
    <script src="/jquery-3.3.1.min.js"</script>
    <link rel="stylesheet" href="/style.css">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <script>
      var camera = 'http://192.168.1.242:8081'
      var ros = new ROSLIB.Ros(); // Make a new ros object
      var roshost = 'ws://192.168.1.242:9090'
      var throttle_default = 0;
      var throttle_max = 10;
      var throttle_min = -10;
      ros.connect(roshost); // Connect the ros object to roshost

      // Publishing
      var cmdVel = new ROSLIB.Topic({ // Create a topic object
        ros : ros,
        name : '/joystick',
        messageType : 'std_msgs/joystick'
        console.log("cmd",cmdVel);
      });
      // Create the message payload to be published
      // Object matches fields defined in .msg
      var rover_message = new ROSLIB.Message({
        arm : {
          j1 : 0,
          j2 : 0,
          j3 : 0,
          j4 : 0,
          j5_1 : 0, // -1, 0, 1
          j5_2 : 0, // -1, 0, 1
        },
        motors : {
          x : 0,
          y : 0
        },
        mode : 0
      });
      cmdVel.publish(rover_message); // Publish the message



      /* BEGIN REMOVAL

      //Subscribing
      var listener = new ROSLIB.Topic({ // Create a topic object
        ros : ros,
        name : '/listener',
        messageType : 'std_msgs/String'
      });
      // Callback for messages published on the topic
      listener.subscribe(function(message) {
        console.log('Received message on ' + listener.name + ': ' + message.data);
      });
      // Unsubscribe from the topic
      //listener.unsubscribe();

      // Calling a service
      var addTwoIntsClient = new ROSLIB.Service({ // Create a service cleint
        ros : ros,
        name : '/add_two_ints',
        serviceType : 'rospy_tutorials/AddTwoInts'
      });
      // Create a service request
      // Object matches fields defined in .srv
      var request = new ROSLIB.ServiceRequest({
        a : 5,
        b : 2
      });
      // Call service /add_two_ints and get back the results in callback
      // Produces a ROSLIB.ServiceResponse object
      addTwoIntsClient.callService(request, function(result) {
        console.log('Result for service call on ' + addTwoIntsClient.name + ': ' + result.sum);
      });

      // Advertising a service
      var setBoolServer = new ROSLIB.Service({ // Create a service cleint
        ros : ros,
        name : '/set_bool',
        serviceType : 'std_srvs/SetBool'
      });
      setBoolServer.advertise(function(request, response) { // Advertise the service
        console.log('Received service request on ' + setBoolServer.name + ': ' + request.data);
        response['success'] = true;
        response['message'] = 'Set successfully';
        return true;
      });

      // Setting/getting a param value
      ros.getParams(function(params) {  // Get available params
        console.log(params);
      });
      // First, we create a Param object with the name of the param.
      var test_param = new ROSLIB.Param({
        ros : ros,
        name : 'max_vel_y'
      });
      // Set the value to be sent to the ROS Parameter Server
      test_param.set(0.8);
      test_param.get(function(value) {
        console.log('test_param: ' + value);
      });

      END REMOVAL  */



      // Report current values
      function reporter() {
          console.log(document.getElementById("throttle").value);
          console.log(rover_message);
          cmdVel.publish(rover_message); // Publish the message
      }

      // After the file has loaded
      $(document).ready(function(){ // Do the following
        $('iframe#roverview1').attr('src', camera); // Load the camera stream
        setInterval(reporter, 100); // Call reporter every 100ms
        document.getElementById("throttle").min = throttle_min;
        document.getElementById("throttle").max = throttle_max;
        document.getElementById("throttle").value = throttle_default;
      });

      ros.on('error', function(error) { // Emit an 'error' if there is an error on the backend
        console.log(error);
        document.getElementById("status_roshost").innerHTML = "Cannot connect: " + error;
        document.getElementById("status_roshost").style = "color:RED";
      });
      ros.on('connection', function() { // Report a successful connection attempt
        console.log("Connected to Rover");
        document.getElementById("status_roshost").innerHTML = "Connected to Rover";
        document.getElementById("status_roshost").style = "color:GREEN";
      });
      /*ros.on('close', function() { // Report a connection closed
        console.log("Rover has closed the connection");
        document.getElementById("status_roshost").innerHTML = "Rover has closed the connection";
        document.getElementById("status_roshost").style = "color:ORANGE";
      });*/

    </script>
  </head>
  <body>
    <div><h1>Titan Rover Cerium</h1></div>
    <div><p id="status_roshost">Status Unavailable</p></div>
    <div><iframe id="roverview1" src=""></iframe></div>
    <div><input type="range" id="throttle"></div>
    <div><label>Throttle</label></div>
  </body>
</html>
